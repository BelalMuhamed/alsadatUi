<div class="salary-container">
  <div class="header-section">
    <h2 class="page-title">إدارة الخصومات على الرواتب</h2>
    <button mat-raised-button color="primary" (click)="openAdd()" class="action-btn">
      <mat-icon>add</mat-icon>
      إضافة خصم
    </button>
  </div>

  <div class="filters mb-3">
    <div class="filter-form w-100 d-flex gap-2 align-items-center" dir="rtl">
      <mat-form-field appearance="outline" class="custom-input-theme" style="min-width:220px;">
        <mat-label>الموظف</mat-label>
        <input type="text" matInput [(ngModel)]="employeeFilter" (ngModelChange)="onEmployeeFilterChange($event)" [matAutocomplete]="auto" placeholder="ابحث بالاسم أو الكود" />
        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onEmployeeSelected($event)">
          <mat-option *ngFor="let e of filteredEmployees" [value]="e.employeeCode || e.code">{{(e.fullName || e.name)}}</mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="outline" class="custom-input-theme" style="min-width:160px;">
        <mat-label>من تاريخ</mat-label>
        <input matInput [matDatepicker]="fromPicker" [(ngModel)]="filters.fromDate" />
        <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
        <mat-datepicker #fromPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="custom-input-theme" style="min-width:160px;">
        <mat-label>إلى تاريخ</mat-label>
        <input matInput [matDatepicker]="toPicker" [(ngModel)]="filters.toDate" />
        <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
        <mat-datepicker #toPicker></mat-datepicker>
      </mat-form-field>

      <div style="display:flex; align-items:center; gap:12px; padding: 8px 12px; margin-bottom: 23px ; background-color: rgba(255, 255, 255, 0.05); border-radius: 4px;">
        <mat-slide-toggle [(ngModel)]="filters.includeDeleted" (change)="applyFilters()" color="primary" style="margin:0;" matTooltip="عرض/إخفاء السجلات المحذوفة">
          <span style="margin-right: 8px;">عرض المحذوف</span>
        </mat-slide-toggle>
      </div>
    </div>

    <div class="w-100 d-flex justify-content-center mt-3 gap-2">
      <button mat-raised-button color="primary" (click)="applyFilters()" class="action-btn">
        <mat-icon>search</mat-icon>
        بحث
      </button>
      <button mat-stroked-button (click)="clearFilters()" class="action-btn">
        <mat-icon>restart_alt</mat-icon>
        إعادة تعيين
      </button>
    </div>
  </div>

  <mat-card class="mt-3">
    <mat-card-content>
      <div *ngIf="isLoading" class="text-center" style="padding: 40px; color: var(--gold);">
        <mat-spinner diameter="50" style="margin: 0 auto;"></mat-spinner>
        <p>جاري التحميل...</p>
      </div>

      <div *ngIf="!isLoading && items.length === 0" class="text-center" style="padding: 40px; color: #999;">
        <mat-icon style="font-size: 48px; width: 48px; height: 48px; margin: 0 auto 16px; opacity: 0.5;">inbox</mat-icon>
        <p>لا توجد خصومات</p>
      </div>

      <div *ngIf="!isLoading && items.length > 0" class="table-container">
        <table mat-table [dataSource]="items" class="mat-elevation-z1" dir="rtl">

          <ng-container matColumnDef="employeeName">
            <th mat-header-cell *matHeaderCellDef>الموظف</th>
            <td mat-cell *matCellDef="let e">{{e.employeeName || e.employeeCode}}</td>
          </ng-container>

          <ng-container matColumnDef="deductionDate">
            <th mat-header-cell *matHeaderCellDef>التاريخ</th>
            <td mat-cell *matCellDef="let e">{{e.deductionDate | date:'yyyy-MM-dd'}}</td>
          </ng-container>

          <ng-container matColumnDef="deductionAmount">
            <th mat-header-cell *matHeaderCellDef>الساعات</th>
            <td mat-cell *matCellDef="let e">{{e.deductionAmount}}</td>
          </ng-container>

          <ng-container matColumnDef="monayAmount">
            <th mat-header-cell *matHeaderCellDef>المبلغ</th>
            <td mat-cell *matCellDef="let e">{{e.monayAmount | number:'1.2-2'}}</td>
          </ng-container>

          <ng-container matColumnDef="reason">
            <th mat-header-cell *matHeaderCellDef>السبب</th>
            <td mat-cell *matCellDef="let e">{{e.deductionReason}}</td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>الإجراءات</th>
            <td mat-cell *matCellDef="let e" class="button-group">
              <button mat-icon-button color="primary" (click)="openEdit(e)" *ngIf="!e.isDeleted" matTooltip="تعديل">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="delete(e)" *ngIf="!e.isDeleted" matTooltip="حذف">
                <mat-icon>delete</mat-icon>
              </button>
              <button mat-icon-button color="accent" (click)="restore(e)" *ngIf="e.isDeleted" matTooltip="استعادة">
                <mat-icon>restore</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['employeeName','deductionDate','deductionAmount','monayAmount','reason','actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['employeeName','deductionDate','deductionAmount','monayAmount','reason','actions']; let i = index;" [class.isDeleted]="row.isDeleted"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <div dir="rtl" class="paginator-container">
    <mat-paginator 
      [length]="totalCount" 
      [pageSize]="pageSize" 
      [pageSizeOptions]="[10,20,50]" 
      (page)="onPageChange($event)" 
      [showFirstLastButtons]="true">
    </mat-paginator>
  </div>

</div>
